<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Green Map 3.9</title>
<link rel="icon" href="data:,">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  body { margin: 0; padding: 0; font-family: Arial; }
  #map { height: 100vh; width: 100vw; }

  .control-panel {
    position: absolute;
    bottom: 10px;
    left: 10px;
    width: 260px;
    z-index: 1000;
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.35);
    overflow: hidden;
  }
  .panel-header {
    background: #2c7be5;
    color: white;
    padding: 8px;
    cursor: pointer;
    font-weight: bold;
    text-align: center;
  }
  .panel-body {
    padding: 10px;
    display: none;
  }
  .panel-body.active { display: block; }

  .panel-body select,
  .panel-body input {
    width: 100%;
    margin: 5px 0;
    padding: 6px;
    font-size: 14px;
  }

  .toggle-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 8px;
    font-size: 14px;
  }

  #resetBtn {
    background: #d9534f;
    border: none;
    width: 100%;
    padding: 7px;
    color: white;
    cursor: pointer;
    border-radius: 4px;
    margin-top: 6px;
  }

  #countDisplay {
    text-align: center;
    font-size: 14px;
    margin-top: 4px;
    font-weight: bold;
  }
</style>
</head>
<body>

<div class="control-panel">
  <div class="panel-header">ðŸ”½ Filters & Options</div>
  <div class="panel-body">
    
    <div class="toggle-row">
      <input type="checkbox" id="clusterToggle" checked>
      <label><b>Enable Clustering</b></label>
    </div>

    <input type="text" id="searchBox" placeholder="Search...">

    <select id="cityFilter" multiple></select>
    <select id="companyFilter" multiple></select>
    <select id="categoryFilter" multiple></select>
    <select id="statusFilter" multiple></select>
    <select id="yearFilter" multiple></select>
    <select id="pocFilter" multiple></select>
    <select id="teamFilter" multiple></select>

    <button id="resetBtn">Reset Filters</button>
    <div id="countDisplay"></div>
  </div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const map = L.map("map").setView([20, 0], 2);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    subdomains: "abcd",
    maxZoom: 19
  }).addTo(map);

  let markerCluster = L.markerClusterGroup();
  map.addLayer(markerCluster);

  const allMarkers = [];
  const searchBox = document.getElementById("searchBox");
  const clusterToggle = document.getElementById("clusterToggle");
  const resetBtn = document.getElementById("resetBtn");
  const countDisplay = document.getElementById("countDisplay");

  // Collapsible panel
  document.querySelector(".panel-header").onclick = () => {
    document.querySelector(".panel-body").classList.toggle("active");
  };

  const filters = {
    City: document.getElementById("cityFilter"),
    Company: document.getElementById("companyFilter"),
    Category: document.getElementById("categoryFilter"),
    Status: document.getElementById("statusFilter"),
    Year: document.getElementById("yearFilter"),
    PoC: document.getElementById("pocFilter"),
    Team: document.getElementById("teamFilter")
  };

  const statusColors = {
    "completed": "green",
    "registered": "blue",
    "intro session pending": "orange",
    "working on documentation": "purple",
    "working on clarification": "brown",
    "report released": "cyan",
    "certificate released": "gold",
    "site audit pending": "gray",
    "inactive": "red"
  };

  function createSvgCircle(color) {
    const size = 32;
    const svg = `
      <svg width="${size}" height="${size}" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" fill="${color}" stroke="black" stroke-width="6"/>
      </svg>`;
    return L.divIcon({ className: "", html: svg, iconSize: [size, size], iconAnchor: [16, 16] });
  }

  async function loadExcel() {
    const buffer = await fetch("dataset.xlsx").then(r => r.arrayBuffer());
    const workbook = XLSX.read(buffer, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    const unique = { City:new Set(), Company:new Set(), Category:new Set(), Status:new Set(), Year:new Set(), PoC:new Set(), Team:new Set() };

    rows.forEach(row => {
      const lat = parseFloat(row.Latitude);
      const lon = parseFloat(row.Longitude);
      if (isNaN(lat) || isNaN(lon)) return;

      const d = {
        City: String(row.City ?? ""),
        Company: String(row["Company Name"] ?? ""),
        Category: String(row.Category ?? ""),
        Status: String(row.Status ?? ""),
        Remark: String(row.Remark ?? ""),
        Year: String(row.Year ?? ""),
        PoC: String(row.PoC ?? ""),
        Team: String(row.Team ?? "")
      };

      const color = statusColors[d.Status.toLowerCase()] || "#333";
      const icon = createSvgCircle(color);

      const marker = L.marker([lat, lon], { icon }).bindPopup(`
        <b>${d.Company}</b><br>
        <b>City:</b> ${d.City}<br>
        <b>Category:</b> ${d.Category}<br>
        <b>Status:</b> ${d.Status}<br>
        <b>Remark:</b> ${d.Remark}<br>
        <b>Year:</b> ${d.Year}<br>
        <b>PoC:</b> ${d.PoC}<br>
        <b>Team:</b> ${d.Team}
      `);

      marker.data = d;
      allMarkers.push(marker);
      markerCluster.addLayer(marker);

      Object.keys(unique).forEach(k => unique[k].add(d[k]));
    });

    Object.keys(filters).forEach(k => {
      [...unique[k]].sort().forEach(v => {
        if (!v) return;
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        filters[k].appendChild(opt);
      });
    });

    applyFilters();
  }

  function applyFilters() {
    markerCluster.clearLayers();
    allMarkers.forEach(m => map.removeLayer(m));

    const searchText = searchBox.value.toLowerCase();
    let count = 0;

    allMarkers.forEach(m => {
      const d = m.data;
      let visible = true;

      Object.keys(filters).forEach(k => {
        const selected = [...filters[k].selectedOptions].map(o => o.value);
        if (selected.length && !selected.includes(d[k])) visible = false;
      });

      if (searchText && !Object.values(d).join(" ").toLowerCase().includes(searchText))
        visible = false;

      if (visible) {
        count++;
        if (clusterToggle.checked) markerCluster.addLayer(m);
        else m.addTo(map);
      }
    });

    countDisplay.textContent = `${count} locations visible`;
  }

  searchBox.addEventListener("input", applyFilters);
  Object.values(filters).forEach(f => f.addEventListener("change", applyFilters));

  clusterToggle.addEventListener("change", () => {
    markerCluster.clearLayers();
    allMarkers.forEach(m => map.removeLayer(m));
    if (clusterToggle.checked) map.addLayer(markerCluster);
    applyFilters();
  });

  resetBtn.addEventListener("click", () => {
    searchBox.value = "";
    Object.values(filters).forEach(f => [...f.options].forEach(o => o.selected = false));
    applyFilters();
  });

  loadExcel();
});
</script>
</body>
</html>
