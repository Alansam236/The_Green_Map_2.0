<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>The Green Map 2.0</title>

  <!-- Prevent favicon 404 -->
  <link rel="icon" href="data:,">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    #map { height: 100vh; width: 100vw; }
    .filter-box {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 6px 10px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      z-index: 1000;
      font-family: Arial;
    }
  </style>
</head>
<body>

<div class="filter-box">
  <label><b>Filter by Category:</b></label>
  <select id="categoryFilter">
    <option value="all">All</option>
  </select>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- SheetJS (Excel reader) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("JS loaded, map initializing...");

  // Initialize map
  const map = L.map('map').setView([20.5937, 78.9629], 5);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  const markerCluster = L.markerClusterGroup().addTo(map);
  const allMarkers = [];
  const categoryDropdown = document.getElementById("categoryFilter");

  // Status color mapping
  const statusColors = {
    "completed": "green",
    "registered": "blue",
    "intro session pending": "orange",
    "working on documentation": "purple",
    "working on clarification": "brown",
    "report released": "cyan",
    "certificate released": "gold",
    "site audit pending": "gray",
    "inactive": "red"
  };

  // Load Excel dataset
  async function loadExcel() {
    try {
      const buffer = await fetch("dataset.xlsx").then(r => r.arrayBuffer());
      const workbook = XLSX.read(buffer, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);
      console.log(`Loaded ${rows.length} rows`);

      const categorySet = new Set();

      rows.forEach(r => {
        const lat = parseFloat(r.Latitude);
        const lon = parseFloat(r.Longitude);
        if (isNaN(lat) || isNaN(lon)) return;

        const Category = r.Category || "Other";
        const Status = r.Status || "";
        const Company = r["Company Name"] || "";
        const City = r.City || "";
        const Year = r.Year || "";
        const PoC = r.PoC || "";
        const Team = r.Team || "";

        const color = statusColors[Status.toLowerCase()] || "black";

        const marker = L.circleMarker([lat, lon], {
          radius: 9,
          fillOpacity: 0.9,
          color: color
        }).bindPopup(`
          <b>${Company}</b><br>
          <b>City:</b> ${City}<br>
          <b>Category:</b> ${Category}<br>
          <b>Status:</b> ${Status}<br>
          <b>Year:</b> ${Year}<br>
          <b>PoC:</b> ${PoC}<br>
          <b>Team:</b> ${Team}
        `);

        marker.category = Category;
        allMarkers.push(marker);
        markerCluster.addLayer(marker);
        categorySet.add(Category);
      });

      // Populate category dropdown
      [...categorySet].sort().forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categoryDropdown.appendChild(opt);
      });

    } catch (err) {
      console.error("âŒ EXCEL LOADING ERROR:", err);
    }
  }

  // Filter markers by category
  categoryDropdown.addEventListener("change", () => {
    const selected = categoryDropdown.value;
    markerCluster.clearLayers();
    allMarkers.forEach(marker => {
      if (selected === "all" || marker.category === selected)
        markerCluster.addLayer(marker);
    });
  });

  loadExcel();
});
</script>

</body>
</html>
