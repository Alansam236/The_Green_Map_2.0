<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Green Map 3.2</title>

<link rel="icon" href="data:,">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  body { margin: 0; padding: 0; font-family: Arial; }
  #map { height: 100vh; width: 100vw; }
  .control-panel {
    position: absolute;
    bottom: 10px;
    left: 10px;
    width: 220px;
    z-index: 1000;
    background: white;
    padding: 8px 10px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
    font-family: Arial;
  }
  .control-panel select,
  .control-panel input {
    width: 100%;
    margin: 4px 0;
    padding: 4px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<div class="control-panel">
  <input type="text" id="searchBox" placeholder="Search..." />
  <select id="cityFilter"><option value="all">All Cities</option></select>
  <select id="companyFilter"><option value="all">All Companies</option></select>
  <select id="categoryFilter"><option value="all">All Categories</option></select>
  <select id="statusFilter"><option value="all">All Statuses</option></select>
  <select id="yearFilter"><option value="all">All Years</option></select>
  <select id="pocFilter"><option value="all">All PoCs</option></select>
  <select id="teamFilter"><option value="all">All Teams</option></select>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // Initialize global map
  const map = L.map('map').setView([20, 0], 2);

  // Use English city names tiles (Carto Light)
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  const markerCluster = L.markerClusterGroup().addTo(map);
  const allMarkers = [];
  const filters = {
    city: document.getElementById("cityFilter"),
    company: document.getElementById("companyFilter"),
    category: document.getElementById("categoryFilter"),
    status: document.getElementById("statusFilter"),
    year: document.getElementById("yearFilter"),
    poc: document.getElementById("pocFilter"),
    team: document.getElementById("teamFilter"),
  };
  const searchBox = document.getElementById("searchBox");

  const statusColors = {
    "completed": "green",
    "registered": "blue",
    "intro session pending": "orange",
    "working on documentation": "purple",
    "working on clarification": "brown",
    "report released": "cyan",
    "certificate released": "gold",
    "site audit pending": "gray",
    "inactive": "red"
  };

  // Load Excel dataset
  async function loadExcel() {
    try {
      const buffer = await fetch("dataset.xlsx").then(r => r.arrayBuffer());
      const workbook = XLSX.read(buffer, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet);
      console.log(`Loaded ${rows.length} rows`);

      const uniqueValues = {
        city: new Set(),
        company: new Set(),
        category: new Set(),
        status: new Set(),
        year: new Set(),
        poc: new Set(),
        team: new Set()
      };

      rows.forEach(r => {
        const lat = parseFloat(r.Latitude);
        const lon = parseFloat(r.Longitude);
        if (isNaN(lat) || isNaN(lon)) return;

        const City = (r.City || "").toString().trim();
        const Company = (r["Company Name"] || "").toString().trim();
        const Category = (r.Category || "Other").toString().trim();
        const Status = (r.Status || "").toString().trim();
        const Year = (r.Year || "").toString().trim();
        const PoC = (r.PoC || "").toString().trim();
        const Team = (r.Team || "").toString().trim();

        const color = statusColors[Status.toLowerCase()] || "black";

        const marker = L.circleMarker([lat, lon], {
          radius: 8,
          fillOpacity: 0.9,
          color: color
        }).bindPopup(`
          <b>${Company}</b><br>
          <b>City:</b> ${City}<br>
          <b>Category:</b> ${Category}<br>
          <b>Status:</b> ${Status}<br>
          <b>Year:</b> ${Year}<br>
          <b>PoC:</b> ${PoC}<br>
          <b>Team:</b> ${Team}
        `);

        marker.data = {City, Company, Category, Status, Year, PoC, Team};
        allMarkers.push(marker);
        markerCluster.addLayer(marker);

        // collect unique filter values
        uniqueValues.city.add(City);
        uniqueValues.company.add(Company);
        uniqueValues.category.add(Category);
        uniqueValues.status.add(Status);
        uniqueValues.year.add(Year);
        uniqueValues.poc.add(PoC);
        uniqueValues.team.add(Team);
      });

      // Populate dropdowns
      Object.keys(filters).forEach(key => {
        const set = uniqueValues[key];
        const dropdown = filters[key];
        [...set].sort().forEach(val => {
          if (val && val !== "") {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val;
            dropdown.appendChild(opt);
          }
        });
      });

    } catch (err) {
      console.error("âŒ EXCEL LOADING ERROR:", err);
    }
  }

  // Apply all filters + search
  function applyFilters() {
    const searchText = (searchBox.value || "").toLowerCase();
    const selectedFilters = {};
    Object.keys(filters).forEach(key => {
      selectedFilters[key] = (filters[key].value || "").toLowerCase().trim();
    });

    markerCluster.clearLayers();

    allMarkers.forEach(marker => {
      const d = marker.data;
      let show = true;

      // column filters
      Object.keys(selectedFilters).forEach(key => {
        if (selectedFilters[key] !== "all" && ((d[key] || "").toString().trim().toLowerCase() !== selectedFilters[key])) {
          show = false;
        }
      });

      // search filter
      const combinedText = Object.values(d).map(v => (v||"").toString().toLowerCase()).join(" ");
      if (searchText && !combinedText.includes(searchText)) show = false;

      if (show) markerCluster.addLayer(marker);
    });
  }

  Object.values(filters).forEach(f => f.addEventListener("change", applyFilters));
  searchBox.addEventListener("input", applyFilters);

  loadExcel();
});
</script>

</body>
</html>