<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Green Map 3.4</title>
<link rel="icon" href="data:,">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  body { margin: 0; padding: 0; font-family: Arial; }
  #map { height: 100vh; width: 100vw; }
  .control-panel {
    position: absolute;
    bottom: 10px;
    left: 10px;
    width: 240px;
    z-index: 1000;
    background: white;
    padding: 8px 10px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.35);
  }
  .control-panel select,
  .control-panel input {
    width: 100%;
    margin: 4px 0;
    padding: 4px;
    box-sizing: border-box;
  }
  .toggle-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 6px 0;
  }
</style>
</head>
<body>

<div class="control-panel">
  <div class="toggle-row">
    <input type="checkbox" id="clusterToggle" checked>
    <label for="clusterToggle">Enable Clustering</label>
  </div>
  <input type="text" id="searchBox" placeholder="Search..." />
  <select id="cityFilter"><option value="all">All Cities</option></select>
  <select id="companyFilter"><option value="all">All Companies</option></select>
  <select id="categoryFilter"><option value="all">All Categories</option></select>
  <select id="statusFilter"><option value="all">All Statuses</option></select>
  <select id="yearFilter"><option value="all">All Years</option></select>
  <select id="pocFilter"><option value="all">All PoCs</option></select>
  <select id="teamFilter"><option value="all">All Teams</option></select>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OSM & CARTO',
    subdomains: 'abcd',
    maxZoom: 19
  }).addTo(map);

  let markerCluster = L.markerClusterGroup();
  map.addLayer(markerCluster);

  const allMarkers = [];
  const filters = {
    City: document.getElementById("cityFilter"),
    Company: document.getElementById("companyFilter"),
    Category: document.getElementById("categoryFilter"),
    Status: document.getElementById("statusFilter"),
    Year: document.getElementById("yearFilter"),
    PoC: document.getElementById("pocFilter"),
    Team: document.getElementById("teamFilter"),
  };
  const searchBox = document.getElementById("searchBox");
  const clusterToggle = document.getElementById("clusterToggle");

  const statusColors = {
    "completed": "green",
    "registered": "blue",
    "intro session pending": "orange",
    "working on documentation": "purple",
    "working on clarification": "brown",
    "report released": "cyan",
    "certificate released": "gold",
    "site audit pending": "gray",
    "inactive": "red"
  };

  async function loadExcel() {
    const buffer = await fetch("dataset.xlsx").then(r => r.arrayBuffer());
    const workbook = XLSX.read(buffer, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    const unique = {City: new Set(), Company: new Set(), Category: new Set(), Status: new Set(), Year: new Set(), PoC: new Set(), Team: new Set()};

    rows.forEach(row => {
      const lat = parseFloat(row.Latitude);
      const lon = parseFloat(row.Longitude);
      if (isNaN(lat) || isNaN(lon)) return;

      const data = {
        City: (row.City || "").trim(),
        Company: (row["Company Name"] || "").trim(),
        Category: (row.Category || "").trim(),
        Status: (row.Status || "").trim(),
        Year: (row.Year || "").trim(),
        PoC: (row.PoC || "").trim(),
        Team: (row.Team || "").trim()
      };

      const marker = L.circleMarker([lat, lon], {
        radius: 8,
        fillOpacity: 0.9,
        color: statusColors[data.Status.toLowerCase()] || "black"
      }).bindPopup(`
        <b>${data.Company}</b><br>
        <b>City:</b> ${data.City}<br>
        <b>Category:</b> ${data.Category}<br>
        <b>Status:</b> ${data.Status}<br>
        <b>Year:</b> ${data.Year}<br>
        <b>PoC:</b> ${data.PoC}<br>
        <b>Team:</b> ${data.Team}
      `);

      marker.data = data;
      allMarkers.push(marker);
      markerCluster.addLayer(marker);

      Object.keys(unique).forEach(k => unique[k].add(data[k]));
    });

    Object.keys(filters).forEach(k => {
      [...unique[k]].sort().forEach(v => {
        if (!v) return;
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        filters[k].appendChild(opt);
      });
    });
  }

  function applyFilters() {
    if (clusterToggle.checked) markerCluster.clearLayers();
    const searchText = searchBox.value.toLowerCase();

    allMarkers.forEach(marker => {
      const d = marker.data;
      let visible = true;

      Object.keys(filters).forEach(k => {
        const selected = filters[k].value;
        if (selected !== "all" && d[k] !== selected) visible = false;
      });

      if (searchText && !Object.values(d).join(" ").toLowerCase().includes(searchText))
        visible = false;

      if (visible) {
        if (clusterToggle.checked)
          markerCluster.addLayer(marker);
        else
          marker.addTo(map);
      } else {
        map.removeLayer(marker);
      }
    });
  }

  Object.values(filters).forEach(f => f.addEventListener("change", applyFilters));
  searchBox.addEventListener("input", applyFilters);

  clusterToggle.addEventListener("change", () => {
    markerCluster.clearLayers();
    allMarkers.forEach(m => map.removeLayer(m)); // reset
    if (clusterToggle.checked) map.addLayer(markerCluster);
    applyFilters();
  });

  loadExcel();
});
</script>

</body>
</html>