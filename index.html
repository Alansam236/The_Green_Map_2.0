<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>The Green Map 3.7</title>
<link rel="icon" href="data:,">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
  #map { height: 100vh; width: 100vw; }

  .control-panel {
    position: absolute;
    bottom: 10px;
    left: 10px;
    width: 240px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
  }
  .control-panel select,
  .control-panel input {
    width: 100%;
    margin: 4px 0;
    padding: 5px;
  }

  .toggle-row {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    margin-bottom: 6px;
  }
</style>
</head>
<body>

<div class="control-panel">

  <div class="toggle-row">
    <input type="checkbox" id="clusterToggle" checked>
    <label for="clusterToggle"><b>Enable Clustering</b></label>
  </div>

  <input type="text" id="searchBox" placeholder="Search..." />
  <select id="cityFilter"><option value="all">All Cities</option></select>
  <select id="companyFilter"><option value="all">All Companies</option></select>
  <select id="categoryFilter"><option value="all">All Categories</option></select>
  <select id="statusFilter"><option value="all">All Statuses</option></select>
  <select id="yearFilter"><option value="all">All Years</option></select>
  <select id="pocFilter"><option value="all">All PoCs</option></select>
  <select id="teamFilter"><option value="all">All Teams</option></select>

</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- MarkerCluster JS -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const map = L.map("map").setView([20, 0], 2);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
    attribution: "&copy; OSM & CARTO",
    subdomains: "abcd",
    maxZoom: 19
  }).addTo(map);

  let markerCluster = L.markerClusterGroup();
  map.addLayer(markerCluster);

  const allMarkers = [];
  const searchBox = document.getElementById("searchBox");
  const clusterToggle = document.getElementById("clusterToggle");

  const filters = {
    City: document.getElementById("cityFilter"),
    Company: document.getElementById("companyFilter"),
    Category: document.getElementById("categoryFilter"),
    Status: document.getElementById("statusFilter"),
    Year: document.getElementById("yearFilter"),
    PoC: document.getElementById("pocFilter"),
    Team: document.getElementById("teamFilter")
  };

  const statusColors = {
    "completed": "green",
    "registered": "blue",
    "intro session pending": "orange",
    "working on documentation": "purple",
    "working on clarification": "brown",
    "report released": "cyan",
    "certificate released": "gold",
    "site audit pending": "gray",
    "inactive": "red"
  };

  async function loadExcel() {
    const buffer = await fetch("dataset.xlsx").then(r => r.arrayBuffer());
    const workbook = XLSX.read(buffer, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    const uniqueValues = {
      City: new Set(), Company: new Set(), Category: new Set(),
      Status: new Set(), Year: new Set(), PoC: new Set(), Team: new Set()
    };

    rows.forEach(row => {
      const lat = parseFloat(row.Latitude);
      const lon = parseFloat(row.Longitude);
      if (isNaN(lat) || isNaN(lon)) return;

      const data = {
        City: String(row.City ?? "").trim(),
        Company: String(row["Company Name"] ?? "").trim(),
        Category: String(row.Category ?? "").trim(),
        Status: String(row.Status ?? "").trim(),
        Remark: String(row.Remark ?? "").trim(), // Popup only
        PoC: String(row.PoC ?? "").trim(),
        Year: String(row.Year ?? "").trim(),
        Team: String(row.Team ?? "").trim()
      };

      const marker = L.circleMarker([lat, lon], {
        radius: 8,
        fillOpacity: 0.9,
        color: statusColors[data.Status.toLowerCase()] || "black"
      }).bindPopup(`
        <b>${data.Company}</b><br>
        <b>City:</b> ${data.City}<br>
        <b>Category:</b> ${data.Category}<br>
        <b>Status:</b> ${data.Status}<br>
        <b>Remark:</b> ${data.Remark}<br>
        <b>Year:</b> ${data.Year}<br>
        <b>PoC:</b> ${data.PoC}<br>
        <b>Team:</b> ${data.Team}
      `);

      marker.data = data;
      allMarkers.push(marker);
      markerCluster.addLayer(marker);

      ["City","Company","Category","Status","Year","PoC","Team"].forEach(k =>
        uniqueValues[k].add(data[k])
      );
    });

    Object.keys(filters).forEach(k => {
      [...uniqueValues[k]].sort().forEach(val => {
        if (!val) return;
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val;
        filters[k].appendChild(opt);
      });
    });
  }

  function applyFilters() {
    markerCluster.clearLayers();
    allMarkers.forEach(m => map.removeLayer(m));

    const searchText = searchBox.value.toLowerCase();

    allMarkers.forEach(marker => {
      const d = marker.data;
      let visible = true;

      Object.keys(filters).forEach(key => {
        const selected = filters[key].value;
        if (selected !== "all" && d[key] !== selected) visible = false;
      });

      if (searchText && !Object.values(d).join(" ").toLowerCase().includes(searchText))
        visible = false;

      if (visible) {
        if (clusterToggle.checked) markerCluster.addLayer(marker);
        else marker.addTo(map);
      }
    });
  }

  Object.values(filters).forEach(f => f.addEventListener("change", applyFilters));
  searchBox.addEventListener("input", applyFilters);

  clusterToggle.addEventListener("change", () => {
    markerCluster.clearLayers();
    allMarkers.forEach(m => map.removeLayer(m));
    if (clusterToggle.checked) map.addLayer(markerCluster);
    applyFilters();
  });

  loadExcel();
});
</script>
</body>
</html>