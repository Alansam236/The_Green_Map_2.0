<body>
<div class="filter-box">
  <label><b>Filter by Category:</b></label>
  <select id="categoryFilter">
    <option value="all">All</option>
  </select>
</div>

<div id="map"></div>

<script>
// --- Initialize Map Immediately ---
console.log("JS loaded, map initializing...");
const map = L.map('map').setView([22.6, 79], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markerCluster = L.markerClusterGroup().addTo(map);

// --- Data holders ---
const categoryDropdown = document.getElementById("categoryFilter");
const allMarkers = [];

// --- Color codes ---
const statusColors = {
  "completed": "green",
  "registered": "blue",
  "intro session pending": "orange",
  "working on documentation": "purple",
  "working on clarification": "brown",
  "report released": "cyan",
  "certificate released": "gold",
  "site audit pending": "gray",
  "inactive": "red"
};

// --- Safe Excel Loading ---
async function loadExcel() {
  try {
    console.log("Reading dataset.xlsx ...");
    const buffer = await fetch("dataset.xlsx").then(r => r.arrayBuffer());
    const workbook = XLSX.read(buffer, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);
    console.log(`Loaded ${rows.length} rows`);

    const categorySet = new Set();

    rows.forEach(r => {
      const lat = parseFloat(r.Latitude);
      const lon = parseFloat(r.Longitude);
      if (isNaN(lat) || isNaN(lon)) return;

      const Category = r.Category || "Other";
      const Status = r.Status || "";
      const Company = r["Company Name"] || "";
      const City = r.City || "";
      const Year = r.Year || "";
      const PoC = r.PoC || "";
      const Team = r.Team || "";

      const color = statusColors[Status.toLowerCase()] || "black";
      const marker = L.circleMarker([lat, lon], {
        radius: 9,
        fillOpacity: 0.9,
        color: color
      }).bindPopup(`
         <b>${Company}</b><br>
         <b>City:</b> ${City}<br>
         <b>Category:</b> ${Category}<br>
         <b>Status:</b> ${Status}<br>
         <b>Year:</b> ${Year}<br>
         <b>PoC:</b> ${PoC}<br>
         <b>Team:</b> ${Team}
      `);

      marker.category = Category;
      allMarkers.push(marker);
      markerCluster.addLayer(marker);
      categorySet.add(Category);
    });

    // populate category filter
    [...categorySet].sort().forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categoryDropdown.appendChild(opt);
    });

  } catch (err) {
    console.error("âŒ EXCEL LOADING ERROR:", err);
  }
}

categoryDropdown.addEventListener("change", () => {
  const selected = categoryDropdown.value;
  markerCluster.clearLayers();
  allMarkers.forEach(marker => {
    if (selected === "all" || marker.category === selected)
      markerCluster.addLayer(marker);
  });
});

// load markers after map is ready
loadExcel();
</script>
</body>

